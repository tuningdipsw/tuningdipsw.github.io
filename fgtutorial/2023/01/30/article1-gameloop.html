<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Let's make a fighting game #1: Introducing our game loop</title>
	<link rel="stylesheet" href="/assets/css/styles.css">
	<link type="application/atom+xml" rel="alternate" href="https://tuningdipsw.github.io/pages/tuningdipsw/feed.xml" title="Home of one of the Hellsinker. players of all time" />
	<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Let’s make a fighting game #1: Introducing our game loop | Home of one of the Hellsinker. players of all time</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Let’s make a fighting game #1: Introducing our game loop" />
<meta name="author" content="minogame" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="« Prev: #0.8: Rollback (Pre-reading) Good day. In this series of articles, I’ll be attempting to program a simple 2D fighting game using the Python game development library Pygame. Teaching the game loop design pattern is a common part of any game programming tutorial, so there’s already plenty of coverage on this topic on the internet, but we’ll go over it again, since it is quite important, and it sets up our next few topics quite nicely. I won’t be regurgitating the lessons of authors who’ve done it better, but I hope to add some useful commentary on how the game loop looks in the context of our fighting game." />
<meta property="og:description" content="« Prev: #0.8: Rollback (Pre-reading) Good day. In this series of articles, I’ll be attempting to program a simple 2D fighting game using the Python game development library Pygame. Teaching the game loop design pattern is a common part of any game programming tutorial, so there’s already plenty of coverage on this topic on the internet, but we’ll go over it again, since it is quite important, and it sets up our next few topics quite nicely. I won’t be regurgitating the lessons of authors who’ve done it better, but I hope to add some useful commentary on how the game loop looks in the context of our fighting game." />
<link rel="canonical" href="https://tuningdipsw.github.io/pages/tuningdipsw/fgtutorial/2023/01/30/article1-gameloop.html" />
<meta property="og:url" content="https://tuningdipsw.github.io/pages/tuningdipsw/fgtutorial/2023/01/30/article1-gameloop.html" />
<meta property="og:site_name" content="Home of one of the Hellsinker. players of all time" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-01-30T12:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Let’s make a fighting game #1: Introducing our game loop" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"minogame"},"dateModified":"2023-01-30T12:00:00+00:00","datePublished":"2023-01-30T12:00:00+00:00","description":"« Prev: #0.8: Rollback (Pre-reading) Good day. In this series of articles, I’ll be attempting to program a simple 2D fighting game using the Python game development library Pygame. Teaching the game loop design pattern is a common part of any game programming tutorial, so there’s already plenty of coverage on this topic on the internet, but we’ll go over it again, since it is quite important, and it sets up our next few topics quite nicely. I won’t be regurgitating the lessons of authors who’ve done it better, but I hope to add some useful commentary on how the game loop looks in the context of our fighting game.","headline":"Let’s make a fighting game #1: Introducing our game loop","mainEntityOfPage":{"@type":"WebPage","@id":"https://tuningdipsw.github.io/pages/tuningdipsw/fgtutorial/2023/01/30/article1-gameloop.html"},"url":"https://tuningdipsw.github.io/pages/tuningdipsw/fgtutorial/2023/01/30/article1-gameloop.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body>
	<div class="page sidebar">
    <nav class="top">
<table>
<tr>
  
  <td>
    <a href="/" >
      Home
    </a>
  <td class="gap">
  
  <td>
    <a href="/about/" >
      About
    </a>
  <td class="gap">
  
  <td>
    <a href="/table-of-contents.html" >
      Contents
    </a>
  <td class="gap">
  
  <td>
    <a href="/staff.html" >
      Author
    </a>
  <td class="gap">
  
</tr>
</table
</nav>

    <h1 class="pagetitle">TUNINGDIPSW</h1>
	<h4>Instructional website for a fighting game developer</h4>
	<h2> Let's make a fighting game #1: Introducing our game loop </h2>
	<div class="content">
    <p>
  30 Jan 2023
  
  
    - <a href="/authors/tuningdipsw.html">TUNING DIPSW (Andrew Hsu)</a>
  
</p>

<div id="table-of-contents">
  <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#distracting-aside">Distracting aside</a></li>
<li class="toc-entry toc-h2"><a href="#game-loop-reading">Game loop reading</a></li>
<li class="toc-entry toc-h2"><a href="#adding-rollback-to-the-mix">Adding rollback to the mix</a></li>
<li class="toc-entry toc-h2"><a href="#could-we-do-better">Could we do better?</a></li>
<li class="toc-entry toc-h2"><a href="#see-you-next-time">See you next time</a></li>
</ul> 
</div>

<p><a href="/fgtutorial/2023/01/27/article0-8-rollback-prep.html">« Prev: #0.8: Rollback (Pre-reading)</a></p>

<p>Good day. In this series of articles, I’ll be attempting to program a simple 2D
fighting game using the Python game development library Pygame.</p>

<p>Teaching the game loop design pattern is a common part of any game programming tutorial,
so there’s already plenty of coverage on this topic on the internet,
but we’ll go over it again, since it is quite important, and it sets up our next few
topics quite nicely.</p>

<p>I won’t be regurgitating the lessons of authors who’ve done it better, but I hope to
add some useful commentary on how the game loop looks in the context of our fighting game.</p>

<!--more-->

<h2 id="distracting-aside">Distracting aside</h2>

<p>You know, I’ve come to realize that these writings are probably going to read more like a devblog than a tutorial.</p>

<p>If I knew how to do the things I’m setting out to do already, then I would have the opportunity to
put together some quite clean and curt no-frills writing, as befits a tutorial. Getting to the point
is quite important, and it respects time of the reader who just wants to paste it and go. But as
it stands, I don’t quite know what will work or what will be good until I’ve tried to write it,
and perhaps not even then. So it is a little dishonest for me to try to write as if the information
I’m about to tell you is quite authoritatively excellent, or the code that I’m about to reproduce
is absolutely up-to-standard, best-practices stuff really, when I’m actually wracking my brain really
hard to try and reason out what I need to do before every new feature.</p>

<p>Sometimes I don’t even do that
and I just type some of the doggest lines I’ve ever written to see if it works (which is a pretty good
approach to get yourself started and writing code, so let us not knock it). Really, trying to write a
tutorial without knowing what I’m about to do isn’t very easy on my end either.</p>

<aside>
Incidentally, the Fall 2022 anime <a href="https://en.wikipedia.org/wiki/Do_It_Yourself!!"><i>Do It Yourself!!</i></a>
was an excellent watch that more than lived up to my iyashikei expectations for the season.
Quite light and quite fun. A worthwhile watch for those looking to fill their own iyashikei needs.
</aside>

<p>Anyways, I just wanted to get that out there before I place some of the smartest-looking dumb words ever
to be put together before you. I think I’m going to end up writing a lot of segments in post to correct
or improve the things I’m about to put forth. But that’s the fun of Doing It Yourself, I guess. Let’s learn a thing or two, together.</p>

<p>And I apologize to you, my readers who must sit through my long-winded foolishness in order to glean
even a spark of potentially useful insight.<br />
And I thank you for reading through it anyways.<br />
I would love to assemble a cleaner version of this text when I’ve put this whole thing together.</p>

<p>And now, we return you to our feature programming.</p>

<h2 id="game-loop-reading">Game loop reading</h2>

<p>The basic game loop that you’ll find in any game library tutorial, like
<a href="https://www.patternsgameprog.com/discover-python-and-patterns-8-game-loop-pattern">this one</a>
or <a href="https://coderslegacy.com/python/display-fps-pygame/">that one</a>
looks something like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">processInput</span><span class="p">()</span>
    <span class="n">update</span><span class="p">()</span>
    <span class="n">render</span><span class="p">()</span>
    <span class="n">clock</span><span class="p">.</span><span class="n">tick</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

<span class="c1"># Ok, this is a bit of a simplification, but pseudocode is fine for now.
</span></code></pre></div></div>

<h2 id="adding-rollback-to-the-mix">Adding rollback to the mix</h2>

<p>Neatly enough, our basic game loop already has updating state and rendering state cleanly separated.
That core requirement of rollback isn’t hard for us to fulfill in Pygame.</p>

<p>We actually have seen what our game loop might look like with rollback in our earlier rollback reading:</p>

<aside>
Interesting note: The presenter mentions that skipping saving the game state in all but the last simulated frame
allowed them to eke out some performance gains in the worst-case scenario.
The tradeoff is that they had to rollback more frames in the average rollback scenario.
<br />
<br />
See <a href="https://youtu.be/7jb0FOcImdg?t=1879">31:19 of the NRS GDC talk</a>.
I don't expect performance to be one of our main worries, so we'll just save it in each of ours.
</aside>

<p><img src="/assets/images/article1/nrs-gameloop-tick-diagram.png" alt="Game loop diagram breakdown of what happens in a rollback frame, from NRS' GDC talk" /></p>

<p><em>Game loop breakdown of what happens in a rollback frame, from <a href="https://youtu.be/7jb0FOcImdg?t=1412">NRS’ GDC talk</a></em>.</p>

<p>The rough code for a gameloop accounting for rollback probably looks something like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span><span class="p">(</span><span class="n">running</span><span class="p">):</span>
    <span class="c1"># --- processInputs() starts here ---
</span>
    <span class="n">processLocalInputs</span><span class="p">()</span>
    <span class="n">sendLocalInputs</span><span class="p">()</span>

    <span class="c1"># Rollback prediction: if no remote inputs are received this frame,
</span>    <span class="c1"># rollback fills in a repeat of last known input
</span>    <span class="n">receiveRemoteInputs</span><span class="p">()</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_inputs</span><span class="p">,</span> <span class="n">remote_inputs</span><span class="p">)</span>

    <span class="c1"># If remote inputs were received, check that they match the prediction.
</span>    <span class="c1"># Then return the frame number of the last correct frame.
</span>    <span class="c1"># (If the prediction has been correct, this is the current frame.)
</span>    <span class="n">frame_to_rollback_to</span> <span class="o">=</span> <span class="n">checkRemoteInputs</span><span class="p">()</span>

    <span class="c1"># --- processInputs() ends here ---
</span>    <span class="c1"># --- update() starts here ---
</span>
    <span class="k">if</span> <span class="n">frame_to_rollback_to</span> <span class="o">!=</span> <span class="n">current_frame</span><span class="p">:</span>
        <span class="n">loadFrameState</span><span class="p">(</span><span class="n">frame_to_rollback_to</span><span class="p">)</span>
    
    <span class="c1"># Simulated frames
</span>    <span class="k">while</span> <span class="n">frame_to_rollback_to</span> <span class="o">!=</span> <span class="n">current_frame</span><span class="p">:</span>
        <span class="n">advanceGameState</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">frame_to_rollback_to</span><span class="p">)</span>
        <span class="n">saveFrameState</span><span class="p">(</span><span class="n">frame_to_rollback_to</span><span class="p">)</span>
        <span class="n">frame_to_rollback_to</span> <span class="o">=</span> <span class="n">frame_to_rollback_to</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Real frame
</span>    <span class="n">advanceGameState</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">current_frame</span><span class="p">)</span>
    <span class="n">saveFrameState</span><span class="p">(</span><span class="n">current_frame</span><span class="p">)</span>
    <span class="n">current_frame</span> <span class="o">=</span> <span class="n">current_frame</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># --- update() ends here ---
</span>    
    <span class="n">render</span><span class="p">(</span><span class="n">game_state</span><span class="p">)</span>
    <span class="n">clock</span><span class="p">.</span><span class="n">tick</span><span class="p">(</span><span class="n">FRAME_RATE_CAP</span><span class="p">)</span> 
</code></pre></div></div>

<p>Actually, consulting the
<a href="https://github.com/pond3r/ggpo/blob/master/doc/DeveloperGuide.md#synchronizing-local-and-remote-inputs">GGPO Developer Guide</a>,
a lot of the parts like <code class="language-plaintext highlighter-rouge">receiveRemoteInputs()</code> and when to call <code class="language-plaintext highlighter-rouge">saveFrameState()</code> and <code class="language-plaintext highlighter-rouge">loadFrameState()</code> are handled by GGPO.
So our loop will look a little different when we integrate that in.</p>

<p>But this is the rough look of the logic underneath, if you need to implement the things GGPO does yourself.</p>

<h2 id="could-we-do-better">Could we do better?</h2>

<p>If you’re familiar with some of the literature on game loops, you might notice that
this version of the game loop is a little imperfect, as <code class="language-plaintext highlighter-rouge">update()</code> is still
somewhat bound to <code class="language-plaintext highlighter-rouge">render()</code>. <code class="language-plaintext highlighter-rouge">update()</code> does have the ability to handle multiple frames of updates per loop,
but it’s doing it more to handle rollbacks than to handle a slow <code class="language-plaintext highlighter-rouge">render()</code> function.</p>

<aside>
And as anyone who has played against me on my goopy laptop, struggling to hit 60FPS in Strive or GBVS, can attest.
</aside>

<p>But I’m going to argue that it’s not the end of the world for now if we bind these together:
it’s not uncommon for fighting games to slow down to the speed of the performance of the slower computer
when playing online, as we alluded to at the end of the rollback article (Mauve’s articles).</p>

<blockquote>
  <p>If one game is running slower than another, dropping a frame here or there, it <strong>cannot</strong> be treated the same as if it were a packet loss. This is because you lose that bonus extra buffer of delay you added to compensate for it, and get effectively nothing of value out of it. Obviously, this isn’t desirable.</p>

  <p>This leads to the most important rule of this sort of network code: The goal is to maintain complete synchronization with the other system. This <strong>includes</strong> performance issues. If one has a drop, this drop must be reflected in the other as well. Always. Anything else will lead to a desynchronization of the intended behavior.</p>
</blockquote>

<p>Note that this refers to drops in the rate that the game state is updating
(and transmitting the inputs that influence how game state updates).
If the drops are only in the rendering rate and not the inputs/updates, they are of course not affecting the game state,
so you wouldn’t have to force the remote computer to reflect that drop.</p>

<p><a href="https://words.infil.net/w02-netcode-p5.html">Infil’s article, part 5</a></p>

<blockquote>
  <p>Solving the problem is relatively straightforward. Most rollback systems will briefly pause the player who is ahead for 1 or 2 frames so the player who is behind can catch up. If the game keeps on top of this system and never lets the games drift very far apart, the correction will be quick and painless. Note that these pauses are not due to missing input or other networking difficulties; they are designed to fix the fact that different computers will run software at slightly different rates in unpredictable ways, and losing 1 frame every 10 seconds to maintain the sync is unnoticeable to even the most astute players.</p>
</blockquote>

<p>It’s not ideal that how fast our game moves can be slowed down by how fast it can render,
but it is passable.</p>

<p>We’re going to start off with this naive game loop for now, just so we can get building.</p>

<p>The main thing we’re worried about is <code class="language-plaintext highlighter-rouge">render()</code> being too slow to hit 60FPS and dragging down our game speed,
but it’s not a good idea to spend too much time worrying about performance drops before they actually appear,
at least in a very lightweight, 2D case such as ours.</p>

<p>So we will put the high-level decoupled game loop ideas on hold until it becomes necessary.
I originally wrote a spot more about this, but since we’re going with this naive loop for now,
it turned into unnecessary clutter.</p>

<p>I’ve confined that section to #1.1, an appendix article.
If you’d like to read more about game loops, you can read it there, or consult the
more expert articles I have cited there.</p>

<p><a href="/fgtutorial/2023/01/31/article1-1-gameloop-tangents.html">» Optional: #1.1: Game loop tangents</a></p>

<h2 id="see-you-next-time">See you next time</h2>

<p>Next time on <b>FIGHTING GAME P</b>, we’ll start by implementing the input processing part of our game loop.
I’m partway through writing it right now and it’s certainly getting a little messy, so it promises to be a meaty one.
I might even have to break it up into multiple parts. So look forward to that.</p>

<p><a href="/fgtutorial/2023/02/06/article2-inputs.html">» Next: #2: Inputs</a></p>


<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    
    var disqus_config = function () {
    this.page.url = "https://tuningdipsw.github.io/fgtutorial/2023/01/30/article1-gameloop.html";
	this.page.identifier = "/fgtutorial/2023/01/30/article1-gameloop.html";
    };
    
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://tuning-2.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  </body>
</html>
